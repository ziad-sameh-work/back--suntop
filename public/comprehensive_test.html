<!DOCTYPE html>
<html>
<head>
    <title>🔧 Comprehensive Order Status Test</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 15px; border-radius: 8px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 12px 20px; margin: 8px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { opacity: 0.8; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .test-data { background-color: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border: 1px solid #dee2e6; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background-color: #f8f9fc; }
    </style>
</head>
<body>
    <h1>🔧 Comprehensive Order Status Update Test</h1>
    
    <div class="test-data">
        <h3>📋 Test Configuration</h3>
        <p><strong>Order ID:</strong> 14</p>
        <p><strong>New Status:</strong> preparing</p>
        <p><strong>Title:</strong> بدء التجهيز</p>
        <p><strong>Message:</strong> تم البدء في تجهيز طلبكم، سيتم إشعاركم عند اكتمال التجهيز</p>
    </div>
    
    <div class="step">
        <h3>Step 1: Check Order Information</h3>
        <button class="btn-primary" onclick="checkOrderInfo()">🔍 Check Order 14</button>
        <p>This will verify that Order 14 exists and has a valid user.</p>
    </div>
    
    <div class="step">
        <h3>Step 2: Test Without Authentication</h3>
        <button class="btn-warning" onclick="testWithoutAuth()">⚠️ Test Debug Route</button>
        <p>This tests the exact same method but without authentication middleware.</p>
    </div>
    
    <div class="step">
        <h3>Step 3: Test With Authentication (Original Issue)</h3>
        <button class="btn-danger" onclick="testWithAuth()">🎯 Test Original Route</button>
        <p>This tests the original problematic endpoint with authentication.</p>
    </div>
    
    <div class="step">
        <h3>Step 4: Check PHP Debug Script</h3>
        <button class="btn-success" onclick="window.open('/test_debug.php', '_blank')">🐛 Open PHP Debug</button>
        <p>This will run comprehensive PHP-level debugging.</p>
    </div>
    
    <button onclick="clearResults()" style="background-color: #6c757d; color: white;">🗑️ Clear Results</button>
    
    <div id="results"></div>
    
    <script>
        const orderId = 14;
        const testData = {
            status: 'preparing',
            title: 'بدء التجهيز',
            message: 'تم البدء في تجهيز طلبكم، سيتم إشعاركم عند اكتمال التجهيز',
            notes: 'Test from comprehensive debug page'
        };
        
        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            div.className = `result ${type}`;
            div.innerHTML = `
                <h4>${title} <small style="font-weight: normal;">(${timestamp})</small></h4>
                <pre>${content}</pre>
            `;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function checkOrderInfo() {
            try {
                addResult('🔍 Checking Order Information...', 'Loading order details...', 'info');
                
                const response = await fetch(`/debug/orders/${orderId}/info`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const responseText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    addResult('❌ Invalid JSON Response', `Status: ${response.status}\nRaw response:\n${responseText}`, 'error');
                    return;
                }
                
                if (response.ok && data.success) {
                    addResult('✅ Order Information Retrieved', JSON.stringify(data.data, null, 2), 'success');
                } else {
                    addResult('❌ Failed to Get Order Info', JSON.stringify(data, null, 2), 'error');
                }
                
            } catch (error) {
                addResult('❌ Network Error in Order Check', error.message, 'error');
            }
        }
        
        async function testWithoutAuth() {
            try {
                addResult('⚠️ Testing Without Authentication...', JSON.stringify(testData, null, 2), 'warning');
                
                const response = await fetch(`/debug/orders/${orderId}/update-status-with-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                
                addResult(
                    `Debug Route Result (Status: ${response.status})`, 
                    `HTTP Status: ${response.status}\n\nResponse:\n${responseText}`,
                    response.ok ? 'success' : 'error'
                );
                
                if (response.ok) {
                    addResult('🎉 Success!', 'The method works when authentication is bypassed. The issue is likely authentication-related.', 'success');
                } else {
                    addResult('🔍 Method Error Found', 'The error occurs even without authentication, so it\'s a code issue.', 'error');
                }
                
            } catch (error) {
                addResult('❌ Network Error in Debug Test', error.message, 'error');
            }
        }
        
        async function testWithAuth() {
            try {
                addResult('🎯 Testing With Authentication...', 'Attempting to get CSRF token and test original route...', 'info');
                
                // First, try to get CSRF token
                const csrfResponse = await fetch('/admin/orders');
                const csrfText = await csrfResponse.text();
                
                let csrfToken = 'no-token';
                const csrfMatch = csrfText.match(/name="csrf-token" content="([^"]+)"/);
                if (csrfMatch) {
                    csrfToken = csrfMatch[1];
                    addResult('📋 CSRF Token', `Found: ${csrfToken.substring(0, 30)}...`, 'info');
                } else {
                    addResult('❌ CSRF Token', 'Could not extract CSRF token from admin page', 'error');
                }
                
                // Test the original problematic endpoint
                const response = await fetch(`/admin/orders/${orderId}/update-status-with-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                
                addResult(
                    `Original Route Result (Status: ${response.status})`,
                    `HTTP Status: ${response.status}\nCSRF Token: ${csrfToken.substring(0, 20)}...\n\nResponse:\n${responseText}`,
                    response.ok ? 'success' : 'error'
                );
                
                // Analyze the result
                if (response.status === 401) {
                    addResult('🔐 Authentication Issue', 'Status 401: Not authenticated. You need to log in as admin first.', 'warning');
                } else if (response.status === 403) {
                    addResult('🚫 Authorization Issue', 'Status 403: Authenticated but not authorized. Check user role.', 'warning');
                } else if (response.status === 419) {
                    addResult('🛡️ CSRF Issue', 'Status 419: CSRF token mismatch. This is common when testing directly.', 'warning');
                } else if (response.status === 422) {
                    addResult('📝 Validation Issue', 'Status 422: Data validation failed. Check request format.', 'warning');
                } else if (response.status === 500) {
                    addResult('💥 Server Error', 'Status 500: Internal server error. This is the main issue we\'re debugging.', 'error');
                } else if (response.ok) {
                    addResult('🎉 Success!', 'The original route works! The issue might have been resolved.', 'success');
                }
                
            } catch (error) {
                addResult('❌ Network Error in Auth Test', error.message, 'error');
            }
        }
    </script>
    
    <div style="margin-top: 40px; padding: 20px; background-color: #e9ecef; border-radius: 8px;">
        <h2>📋 Instructions</h2>
        <ol>
            <li><strong>Run Step 1</strong> to verify Order 14 exists and has a user</li>
            <li><strong>Run Step 2</strong> to test the method without authentication interference</li>
            <li><strong>Run Step 3</strong> to test the original problematic endpoint</li>
            <li><strong>Check Step 4</strong> for PHP-level debugging if needed</li>
        </ol>
        
        <h3>🎯 Expected Results</h3>
        <ul>
            <li>If <strong>Step 2 succeeds but Step 3 fails</strong> → Authentication/CSRF issue</li>
            <li>If <strong>both Step 2 and 3 fail</strong> → Code logic issue</li>
            <li>If <strong>both steps succeed</strong> → Issue resolved!</li>
        </ul>
        
        <p><strong>Access:</strong> <code>http://127.0.0.1:8000/comprehensive_test.html</code></p>
    </div>
</body>
</html>
